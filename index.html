<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Primário -->
    <title>Crom Tools | Ferramentas Web Privadas</title>
    <meta name="description"
        content="Ferramentas online gratuitas e 100% privadas. Converta Markdown, imagens e comprima arquivos localmente.">
    <meta name="keywords" content="ferramentas online, conversor markdown, compressor imagem, privacidade, crom tools">

    <!-- Tailwind CSS & Lucide Icons (Local) -->
    <script src="crom-static/v1/js/vendor/tailwind.js"></script>
    <script src="crom-static/v1/js/vendor/lucide.min.js"></script>

    <!-- Marked.js for Markdown -->
    <script src="crom-static/v1/js/marked.min.js"></script>
    <!-- Debugger -->
    <script src="crom-static/v1/js/debug.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }

        .tool-active .popup-overlay {
            display: block;
        }

        .nav-active {
            color: #4f46e5 !important;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }

        .dark .progress-container {
            background-color: #334155;
        }

        .progress-bar {
            width: 0%;
            height: 6px;
            background-color: #4f46e5;
            transition: width 0.3s ease;
        }

        /* Print Styles for clean PDF generation */
        @media print {
            body * {
                visibility: hidden;
            }

            #toolPopup,
            #toolPopup * {
                visibility: visible;
            }

            #toolPopup {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 0;
                margin: 0;
            }

            /* Hide editor column, show preview full width */
            #toolContent>div {
                display: block !important;
            }

            #toolContent>div>div:first-child {
                display: none !important;
            }

            /* Editor */
            #toolContent>div>div:last-child {
                display: block !important;
                width: 100% !important;
                border: none !important;
                padding: 0 !important;
            }

            #mdPreview {
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
                height: auto !important;
                padding: 0 !important;
            }

            /* Hide UI controls */
            button,
            .border-b,
            #toolStatus,
            ::-webkit-scrollbar {
                display: none !important;
            }
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { indigo: { 600: '#4f46e5', 700: '#4338ca' } }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300">

    <!-- Container onde o JS montará tudo -->
    <div id="app"></div>

    <!-- Popup Overlay (Fixo) -->
    <div id="toolPopup" class="popup-overlay overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
            <div
                class="bg-white dark:bg-slate-900 w-full max-w-5xl rounded-3xl shadow-2xl flex flex-col relative overflow-hidden animate-in zoom-in duration-300">
                <div
                    class="flex items-center justify-between p-6 border-b dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/20">
                    <div class="flex items-center gap-4">
                        <div id="toolIconContainer" class="p-2 rounded-lg text-white"></div>
                        <div>
                            <h2 id="toolTitle" class="text-xl font-black tracking-tight"></h2>
                            <p id="toolDesc" class="text-xs text-slate-500"></p>
                        </div>
                    </div>
                    <button onclick="closeTool()"
                        class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div id="toolContent" class="p-8 overflow-y-auto max-h-[75vh]"></div>
                <!-- Status Bar -->
                <div id="toolStatus" class="px-8 pb-4 hidden">
                    <div class="flex justify-between text-xs text-slate-500 mb-1">
                        <span id="statusText">Processando...</span>
                        <div class="flex gap-2">
                            <span id="batchCount" class="hidden font-bold">0/0</span>
                            <span id="statusPercent">0%</span>
                        </div>
                    </div>
                    <div class="progress-container" id="progressBarContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div id="resultsContainer" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden"></div>
                    <div id="errorMessage"
                        class="hidden mt-2 p-3 bg-red-100 text-red-700 rounded-lg text-sm border border-red-200"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SERVIÇOS DE BACKEND (API) ---
        const API_BASE = 'http://localhost:3000/v1';

        // --- INDEXEDDB (HISTORY) ---
        const DB_NAME = 'CromToolsDB';
        const DB_VERSION = 1;
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('history')) {
                        const store = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB initialized');
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        const addToHistory = (tool, filename, resultBlob) => {
            if (!db) return;
            const transaction = db.transaction(['history'], 'readwrite');
            const store = transaction.objectStore('history');
            const item = {
                tool: tool,
                filename: filename,
                timestamp: new Date(),
                // Store blob ? Or just metadata? Storing blobs can fill quota fast.
                // Let's store metadata for now, or small blobs.
                // For privacy, we keep it local.
                size: resultBlob.size,
                type: resultBlob.type
            };
            store.add(item);
        };

        // --- PROGRESS & UI HELPERS ---
        function showProgress(text, isBatch = false) {
            document.getElementById('toolStatus').classList.remove('hidden');
            document.getElementById('progressBarContainer').style.display = 'block';
            document.getElementById('statusText').innerText = text;
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = ''; // Clear prev results
            document.getElementById('resultsContainer').classList.add('hidden');

            if (isBatch) {
                document.getElementById('batchCount').classList.remove('hidden');
            } else {
                document.getElementById('batchCount').classList.add('hidden');
            }
            updateProgress(5);
        }

        function updateProgress(percent, current, total) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('statusPercent').innerText = percent + '%';

            if (current !== undefined && total !== undefined) {
                document.getElementById('batchCount').innerText = `${current}/${total}`;
            }
        }

        function hideProgress() {
            // Keep results visible
            // document.getElementById('toolStatus').classList.add('hidden'); 
            // Just hide the bar
            document.getElementById('progressBarContainer').style.display = 'none';
            document.getElementById('statusText').innerText = 'Concluído!';
        }

        function showError(msg) {
            document.getElementById('toolStatus').classList.remove('hidden');
            document.getElementById('progressBarContainer').style.display = 'none';
            const errDiv = document.getElementById('errorMessage');
            errDiv.innerText = msg;
            errDiv.classList.remove('hidden');
            document.getElementById('statusText').innerText = 'Erro';
        }

        function addResult(blob, filename) {
            const container = document.getElementById('resultsContainer');
            container.classList.remove('hidden');

            const url = URL.createObjectURL(blob);

            const div = document.createElement('div');
            div.className = 'p-2 border rounded-lg flex flex-col items-center gap-2 bg-slate-50 dark:bg-slate-800';
            div.innerHTML = `
                 <div class="h-20 w-full bg-slate-200 dark:bg-slate-700 rounded flex items-center justify-center overflow-hidden">
                    ${blob.type.startsWith('image') ? `<img src="${url}" class="h-full object-contain">` : '<i data-lucide="file" class="w-8 h-8"></i>'}
                 </div>
                 <span class="text-xs truncate w-full text-center" title="${filename}">${filename}</span>
                 <a href="${url}" download="${filename}" class="text-xs bg-indigo-600 text-white px-2 py-1 rounded w-full text-center hover:bg-indigo-700">Baixar</a>
             `;
            container.appendChild(div);
            lucide.createIcons();

            addToHistory('image-conversion', filename, blob);
        }


        function generatePDF(btn) {
            const htmlContent = document.getElementById('mdPreview').innerHTML;
            if (!htmlContent || htmlContent === '<p class="text-slate-300">Digite algo...</p>') {
                return alert('O conteúdo está vazio!');
            }
            window.print();
        }

        // --- IMAGE PROCESSING LOGIC ---
        async function processImageBatch(files) {
            const MAX_LOCAL_SIZE = 2 * 1024 * 1024; // 2MB
            const total = files.length;
            let processedCount = 0;

            showProgress('Iniciando processamento...', true);
            updateProgress(0, 0, total);

            for (let i = 0; i < total; i++) {
                const file = files[i];
                updateProgress(Math.floor((i / total) * 100), i + 1, total);
                document.getElementById('statusText').innerText = `Processando ${file.name}...`;

                try {
                    let blob;
                    if (file.size > MAX_LOCAL_SIZE) {
                        // SERVER SIDE
                        console.log(`File ${file.name} > 2MB, sending to server.`);
                        blob = await processImageServer(file);
                    } else {
                        // CLIENT SIDE
                        console.log(`File ${file.name} < 2MB, processing locally.`);
                        blob = await processImageLocal(file);
                    }
                    addResult(blob, `processed-${file.name}`);
                } catch (e) {
                    console.error(`Error processing ${file.name}:`, e);
                    // Just show a small error in console for now or add explicit error item
                }

                processedCount++;
            }

            updateProgress(100, total, total);
            hideProgress();
        }

        async function processImageServer(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('action', 'convert');
            formData.append('format', 'png'); // Defaulting to png for now

            const response = await fetch(`${API_BASE}/process/image`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Server Error');
            return await response.blob();
        }

        function processImageLocal(file) {
            return new Promise((resolve, reject) => {
                if (window.Worker) {
                    const worker = new Worker('crom-static/v1/js/worker-image.js');
                    // Send single file to worker (our worker now supports list but also single)
                    // We loop here in main thread to manage hybrid logic (Size check)
                    // So we treat worker as a "single task" processor here for simplicity in hybrid loop.
                    // Or we could batch send small files. But mixing small/large in one batch is tricky.
                    // Let's keep it simple: One by one invocation for mixed batch.
                    worker.postMessage({ file: file, action: 'convert', format: 'png' });

                    worker.onmessage = function (e) {
                        if (e.data.type === 'result' || e.data.success) { // Handle old & new worker format
                            if (e.data.success) {
                                resolve(e.data.blob);
                            } else {
                                reject(e.data.error);
                            }
                        } else if (e.data.success === false) {
                            reject(e.data.error);
                        }
                        worker.terminate();
                    };
                    worker.onerror = (e) => reject(e);
                } else {
                    reject("Web Workers not supported");
                }
            });
        }

        // --- CONFIGURAÇÃO DAS FERRAMENTAS ---
        const TOOLS_CONFIG = [
            {
                id: 'md-pdf',
                title: 'Markdown → PDF',
                desc: 'Editor e conversor local com prévia real.',
                icon: 'file-text',
                color: 'bg-blue-500',
                tags: ['markdown', 'pdf', 'texto', 'converter'],
                render: () => `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[450px]">
                        <div class="flex flex-col gap-2">
                            <span class="text-[10px] font-bold text-slate-400">EDITOR</span>
                            <textarea id="mdInput" onkeyup="updateMDPreview()" class="flex-1 p-4 rounded-xl border dark:border-slate-800 bg-slate-50 dark:bg-slate-950 font-mono text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="# Comece a escrever..."></textarea>
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[10px] font-bold text-slate-400">PRÉVIA</span>
                            <div id="mdPreview" class="flex-1 bg-white dark:bg-slate-800 border dark:border-slate-800 rounded-xl p-6 overflow-y-auto prose dark:prose-invert"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end"><button onclick="generatePDF(this)" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">Imprimir / Salvar PDF</button></div>
                `
            },
            {
                id: 'img-conv',
                title: 'Conversor de Imagem',
                desc: 'WebP, PNG, JPG processados localmente ou via nuvem.',
                icon: 'image',
                color: 'bg-emerald-500',
                tags: ['imagem', 'foto', 'conversor', 'png', 'jpg'],
                render: () => `
                    <div class="text-center py-20 border-4 border-dashed border-slate-100 dark:border-slate-800 rounded-3xl hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <i data-lucide="upload" class="mx-auto w-12 h-12 text-emerald-500 mb-4"></i>
                        <h3 class="text-xl font-bold">Arraste seus arquivos</h3>
                        <p class="text-slate-400 mt-2">Processamento Híbrido: < 2MB (Local), > 2MB (Nuvem Segura)</p>
                        <div class="relative mt-6 inline-block">
                            <button class="bg-emerald-500 text-white px-10 py-3 rounded-xl font-bold hover:bg-emerald-600 transition-colors pointer-events-none">Escolher Arquivos</button>
                            <!-- Added 'multiple' attribute -->
                            <input type="file" multiple onchange="window.handleImageUpload(this)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                        </div>
                    </div>
                `
            },
            {
                id: 'compress',
                title: 'Compressor Pro',
                desc: 'Redução de tamanho sem perda de qualidade.',
                icon: 'file-archive',
                color: 'bg-amber-500',
                tags: ['comprimir', 'zip', 'otimizar', 'tamanho'],
                render: () => `
                    <div class="max-w-md mx-auto py-12 text-center">
                        <div class="w-20 h-20 bg-amber-50 dark:bg-amber-900/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                             <i data-lucide="minimize" class="w-10 h-10 text-amber-500"></i>
                        </div>
                        <h3 class="text-2xl font-black mb-4">Redução Inteligente</h3>
                        <p class="text-slate-500 mb-8">Nossa tecnologia local otimiza seus arquivos em segundos.</p>
                        <button class="w-full bg-amber-500 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-amber-500/20 hover:shadow-amber-500/40 transition-shadow">Selecionar Arquivo</button>
                    </div>
                `
            },
            {
                id: 'pwd-gen',
                title: 'Gerador de Senha',
                desc: 'Crie senhas fortes localmente. Nenhuma dado sai do seu dispositivo.',
                icon: 'lock',
                color: 'bg-rose-500',
                tags: ['senha', 'segurança', 'privacidade', 'gerador'],
                render: () => `
                    <div class="max-w-md mx-auto py-8">
                        <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-2xl mb-6 flex items-center justify-between">
                            <span id="pwdDisplay" class="font-mono text-xl tracking-wider select-all">Clique em Gerar</span>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('pwdDisplay').innerText)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg"><i data-lucide="copy"></i></button>
                        </div>
                        <button onclick="document.getElementById('pwdDisplay').innerText = Array(20).fill('0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&*()').map(x => x[Math.floor(Math.random() * x.length)]).join('')" class="w-full bg-rose-500 text-white py-4 rounded-xl font-bold hover:bg-rose-600 transition-colors">Gerar Nova Senha</button>
                    </div>
                `
            },
            {
                id: 'meta-strip',
                title: 'Metadata Stripper',
                desc: 'Remova dados ocultos (EXIF) de suas fotos para privacidade total.',
                icon: 'eraser',
                color: 'bg-purple-500',
                tags: ['exif', 'privacidade', 'limpar', 'foto'],
                render: () => `
                     <div class="text-center py-20 border-4 border-dashed border-slate-100 dark:border-slate-800 rounded-3xl hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <i data-lucide="shield-check" class="mx-auto w-12 h-12 text-purple-500 mb-4"></i>
                        <h3 class="text-xl font-bold">Limpeza de Metadados</h3>
                        <p class="text-slate-400 mt-2">Remove GPS, modelo da câmera e data original.</p>
                        <div class="relative mt-6 inline-block">
                             <button class="bg-purple-500 text-white px-10 py-3 rounded-xl font-bold hover:bg-purple-600 transition-colors pointer-events-none">Selecionar Fotos</button>
                             <input type="file" multiple accept="image/*" onchange="window.handleMetadataStrip(this)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                        </div>
                    </div>
                `
            },
            {
                id: 'ocr-tool',
                title: 'OCR (Texto de Imagem)',
                desc: 'Extraia texto de imagens digitalizadas ou fotos.',
                icon: 'scan-text',
                color: 'bg-orange-500',
                tags: ['ocr', 'texto', 'extrair', 'ler', 'imagem'],
                render: () => `
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[450px]">
                        <div class="flex flex-col gap-2">
                             <div class="text-center py-10 border-4 border-dashed border-slate-100 dark:border-slate-800 rounded-3xl hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors flex-1 flex flex-col items-center justify-center">
                                <i data-lucide="scan-line" class="mx-auto w-10 h-10 text-orange-500 mb-4"></i>
                                <h3 class="text-lg font-bold">Envie uma Imagem</h3>
                                <div class="relative mt-4 inline-block">
                                     <button class="bg-orange-500 text-white px-8 py-2 rounded-xl font-bold hover:bg-orange-600 transition-colors pointer-events-none">Upload</button>
                                     <input type="file" accept="image/*" onchange="window.handleOCR(this)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[10px] font-bold text-slate-400">TEXTO EXTRAÍDO</span>
                            <textarea id="ocrResult" readonly class="flex-1 p-4 rounded-xl border dark:border-slate-800 bg-slate-50 dark:bg-slate-950 font-mono text-xs outline-none focus:ring-2 focus:ring-orange-500 resize-none" placeholder="O texto extraído aparecerá aqui..."></textarea>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('ocrResult').value)" class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors">Copiar Texto</button>
                        </div>
                    </div>
                `
            }
        ];

        // --- ESTADO GLOBAL ---
        let currentView = 'inicio';
        let searchQuery = '';

        // --- COMPONENTES DE INTERFACE ---
        // (Same as before, simplified for brevity here if needed, but keeping full)
        const Header = () => `
            <header class="sticky top-0 z-50 glass-effect">
                <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                    <a href="javascript:void(0)" onclick="app.navigate('inicio')" class="flex items-center gap-2 group">
                        <div class="bg-indigo-600 p-1.5 rounded-lg group-hover:rotate-6 transition-transform">
                            <i data-lucide="zap" class="text-white w-5 h-5 fill-current"></i>
                        </div>
                        <span class="text-xl font-black tracking-tighter">CROM<span class="text-indigo-600">TOOLS</span></span>
                    </a>
                    <nav class="hidden md:flex items-center gap-8 text-sm font-semibold">
                        <button onclick="app.navigate('inicio')" class="nav-link ${currentView === 'inicio' ? 'nav-active' : 'text-slate-500 hover:text-indigo-600'} transition-colors">Início</button>
                        <button onclick="app.navigate('sobre')" class="nav-link ${currentView === 'sobre' ? 'nav-active' : 'text-slate-500 hover:text-indigo-600'} transition-colors">Sobre</button>
                         <button onclick="app.navigate('historico')" class="nav-link ${currentView === 'historico' ? 'nav-active' : 'text-slate-500 hover:text-indigo-600'} transition-colors">Histórico</button>
                    </nav>
                    <div class="flex items-center gap-4">
                        <button onclick="app.toggleDark()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500">
                            <i data-lucide="${document.documentElement.classList.contains('dark') ? 'sun' : 'moon'}"></i>
                        </button>
                    </div>
                </div>
            </header>
        `;

        const HomeView = () => `
            <div class="animate-in fade-in duration-500">
                <section class="max-w-7xl mx-auto px-6 py-20 text-center">
                    <h1 class="text-5xl md:text-7xl font-black mb-8 tracking-tight">
                        Simples. Rápido. <br class="hidden md:block">
                        <span class="text-indigo-600 underline decoration-indigo-200 underline-offset-8">Privado.</span>
                    </h1>
                     <div class="relative max-w-2xl mx-auto mb-16 group">
                        <div class="absolute inset-y-0 left-5 flex items-center pointer-events-none">
                            <i data-lucide="search" class="text-slate-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5"></i>
                        </div>
                        <input 
                            type="text" 
                            id="toolSearch"
                            placeholder="Pesquise por uma ferramenta..."
                            class="w-full pl-14 pr-6 py-5 rounded-2xl bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 shadow-2xl focus:border-indigo-500 outline-none text-lg transition-all"
                            onkeyup="app.handleSearch(this.value)"
                            value="${searchQuery}"
                        >
                    </div>
                    <div id="toolsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
                        ${renderCards()}
                    </div>
                </section>
            </div>
        `;

        const SobreView = () => `
            <div class="animate-in slide-in-from-bottom-4 duration-500">
                <section class="max-w-4xl mx-auto px-6 py-20">
                     <div class="text-center mb-16">
                        <h2 class="text-5xl font-black mb-6">Nossa Filosofia</h2>
                        <p class="text-xl text-slate-500">Ferramentas que respeitam sua privacidade.</p>
                    </div>
                    <!-- Same text as before -->
                     <button onclick="app.navigate('inicio')" class="bg-white text-indigo-600 px-10 py-4 rounded-xl font-black hover:scale-105 transition-transform">Voltar às Ferramentas</button>
                </section>
            </div>
        `;

        const HistoricoView = () => `
            <div class="animate-in slide-in-from-bottom-4 duration-500">
                <section class="max-w-4xl mx-auto px-6 py-20">
                    <h2 class="text-3xl font-black mb-8">Histórico Local</h2>
                    <p class="text-slate-500 mb-8">Seus arquivos processados recentemente (Metadados apenas).</p>
                    
                    <div id="historyList" class="space-y-4">
                        <div class="p-8 text-center text-slate-400">Carregando histórico...</div>
                    </div>
                </section>
            </div>
        `;

        const Footer = () => `
            <footer class="py-16 px-6 text-center border-t dark:border-slate-800 mt-20">
                <p class="text-slate-400 text-xs uppercase tracking-widest">© 2026 Crom Tools. Processamento Híbrido.</p>
            </footer>
        `;

        function loadHistory() {
            if (!db) return;
            const transaction = db.transaction(['history'], 'readonly');
            const store = transaction.objectStore('history');
            const request = store.openCursor(null, 'prev'); // Newest first
            const list = document.getElementById('historyList');
            if (activeHistoryRequest) return; // Prevent double load

            list.innerHTML = '';
            let activeHistoryRequest = true;

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const item = cursor.value;
                    const date = new Date(item.timestamp).toLocaleString();
                    const el = document.createElement('div');
                    el.className = 'bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <div class="font-bold">${item.filename}</div>
                            <div class="text-xs text-slate-400">${item.tool} • ${date}</div>
                        </div>
                        <div class="text-xs font-mono bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">
                            ${(item.size / 1024).toFixed(1)} KB
                        </div>
                    `;
                    list.appendChild(el);
                    cursor.continue();
                } else {
                    if (list.innerHTML === '') list.innerHTML = '<div class="text-slate-400">Nenhum histórico encontrado.</div>';
                }
            }
        }

        // --- LÓGICA DE RENDERIZAÇÃO ---
        function renderCards() {
            const filtered = TOOLS_CONFIG.filter(t =>
                t.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                t.tags.some(tag => tag.includes(searchQuery.toLowerCase()))
            );

            if (filtered.length === 0) return `<div class="col-span-full py-20 text-center text-slate-400">Nenhuma ferramenta encontrada.</div>`;

            return filtered.map(tool => `
                <div class="tool-card group p-8 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 hover:shadow-xl transition-all cursor-pointer" 
                     onclick="app.openTool('${tool.id}')">
                    <div class="${tool.color} w-12 h-12 rounded-xl flex items-center justify-center text-white mb-6 group-hover:scale-110 transition-transform">
                        <i data-lucide="${tool.icon}"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">${tool.title}</h3>
                    <p class="text-slate-500 text-sm leading-relaxed">${tool.desc}</p>
                </div>
            `).join('');
        }

        // --- OBJETO APP (MÉTODO PRINCIPAL) ---
        const app = {
            init() {
                initDB().then(() => this.render());
            },
            render() {
                const container = document.getElementById('app');

                let viewContent = '';
                if (currentView === 'inicio') viewContent = HomeView();
                else if (currentView === 'sobre') viewContent = SobreView();
                else if (currentView === 'historico') viewContent = HistoricoView();

                container.innerHTML = `
                    ${Header()}
                    <main>
                        ${viewContent}
                    </main>
                    ${Footer()}
                `;
                lucide.createIcons();

                if (currentView === 'inicio') {
                    const search = document.getElementById('toolSearch');
                    if (search) search.focus();
                }
                if (currentView === 'historico') {
                    loadHistory();
                }
            },
            navigate(viewId) {
                currentView = viewId;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.render();
            },
            handleSearch(val) {
                searchQuery = val;
                const grid = document.getElementById('toolsGrid');
                if (grid) {
                    grid.innerHTML = renderCards();
                    lucide.createIcons();
                }
            },
            toggleDark() {
                document.documentElement.classList.toggle('dark');
                this.render();
            },
            openTool(id) {
                const tool = TOOLS_CONFIG.find(t => t.id === id);
                document.getElementById('toolTitle').innerText = tool.title;
                document.getElementById('toolDesc').innerText = tool.desc;
                document.getElementById('toolIconContainer').className = `p-2 rounded-lg text-white ${tool.color}`;
                document.getElementById('toolIconContainer').innerHTML = `<i data-lucide="${tool.icon}"></i>`;
                document.getElementById('toolContent').innerHTML = tool.render();

                document.getElementById('toolStatus').classList.add('hidden');
                document.body.classList.add('tool-active');
                lucide.createIcons();
            }
        };

        function closeTool() { document.body.classList.remove('tool-active'); }
        function updateMDPreview() {
            const input = document.getElementById('mdInput').value;
            const html = typeof marked !== 'undefined'
                ? marked.parse(input)
                : input.replace(/\n/g, '<br>');
            document.getElementById('mdPreview').innerHTML = html || '<p class="text-slate-300">Digite algo...</p>';
        }

        // Exposing handlers
        window.generatePDF = generatePDF;
        window.handleImageUpload = async (input) => {
            const files = input.files;
            if (!files || files.length === 0) return;

            const btn = input.parentElement.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Processando...';

            try {
                // Now accepts FileList
                await processImageBatch(files);
            } catch (e) {
                console.error(e);
            } finally {
                btn.innerText = originalText;
                input.value = ''; // Reset to allow same file selection again
            }
        };

        window.handleMetadataStrip = async (input) => {
            const files = input.files;
            if (!files || files.length === 0) return;

            const btn = input.parentElement.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Limpando...';

            showProgress('Iniciando limpeza...', true);
            updateProgress(0, 0, files.length);

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProgress(Math.floor((i / files.length) * 100), i + 1, files.length);
                    document.getElementById('statusText').innerText = `Limpando ${file.name}...`;

                    const formData = new FormData();
                    formData.append('image', file);
                    formData.append('action', 'strip');

                    // Helper for strip specific call
                    const response = await fetch(`${API_BASE}/process/image`, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Falha no servidor');

                    const blob = await response.blob();
                    addResult(blob, `clean-${file.name}`);
                }
            } catch (e) {
                console.error(e);
                showError("Erro ao limpar metadados.");
            } finally {
                btn.innerText = originalText;
                input.value = '';
                updateProgress(100, files.length, files.length);
                hideProgress();
            }
        };

        window.handleOCR = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const btn = input.parentElement.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Lendo...';
            document.getElementById('ocrResult').value = "Processando... aguarde.";

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`${API_BASE}/heavy/ocr`, { method: 'POST', body: formData });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Erro desconhecido');
                }

                document.getElementById('ocrResult').value = data.text || "Nenhum texto encontrado.";
            } catch (e) {
                console.error(e);
                document.getElementById('ocrResult').value = `ERRO: ${e.message}`;
            } finally {
                btn.innerText = originalText;
                input.value = '';
            }
        };

        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeTool(); });

        app.init();
    </script>
</body>

</html>